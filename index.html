<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Music Monster - ××•×œ×¤×Ÿ ×”×¤×§×” ××§×¦×•×¢×™</title>
    <style>
        :root {
            --neon-blue: #00f2ff;
            --neon-purple: #bc13fe;
            --neon-green: #39ff14;
            --bg-dark: #0a0a0f;
            --panel-bg: #161625;
            --text-color: #e0e0e0;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 95%;
            max-width: 1400px;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 30px 0;
            background: linear-gradient(180deg, rgba(0,242,255,0.1) 0%, transparent 100%);
            border-radius: 0 0 50px 50px;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 3rem;
            margin: 0;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(188, 19, 254, 0.3);
        }

        .main-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 25px;
        }

        /* Sidebar Settings */
        .sidebar {
            background: var(--panel-bg);
            padding: 25px;
            border-radius: 24px;
            border: 1px solid #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            height: fit-content;
        }

        .control-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--neon-blue);
        }

        input[type="text"], input[type="password"], textarea, select {
            width: 100%;
            padding: 12px;
            background: #000;
            border: 1px solid #444;
            border-radius: 12px;
            color: #fff;
            font-size: 1rem;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary { background: var(--neon-blue); color: #000; }
        .btn-success { background: var(--neon-green); color: #000; }
        .btn-record { background: #ff4444; color: #fff; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .btn:hover:not(:disabled) { transform: scale(1.02); filter: brightness(1.1); }

        /* Main Workspace */
        .workspace {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: var(--panel-bg);
            padding: 20px;
            border-radius: 24px;
            border: 1px solid #333;
        }

        .visualizer-box {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            height: 250px;
        }

        canvas {
            width: 100%;
            height: 100%;
            background: #000;
            border-radius: 15px;
        }

        /* Mixer UI */
        .mixer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .channel {
            background: #0d0d16;
            padding: 10px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid #222;
        }

        .vu-meter {
            height: 120px;
            width: 12px;
            background: #111;
            margin: 10px auto;
            border-radius: 6px;
            position: relative;
            overflow: hidden;
        }

        .vu-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 0%;
            background: linear-gradient(to top, #0f0, #ff0, #f00);
            transition: height 0.1s;
        }

        .fader {
            -webkit-appearance: slider-vertical;
            width: 25px;
            height: 80px;
        }

        /* Arrangement Timeline */
        .timeline {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            padding: 15px;
            background: #000;
            border-radius: 15px;
            min-height: 50px;
        }

        .segment {
            flex: 0 0 100px;
            height: 40px;
            background: #1a1a2e;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            border: 1px solid #333;
            transition: 0.3s;
        }

        .segment.active {
            background: var(--neon-blue);
            color: #000;
            box-shadow: 0 0 15px var(--neon-blue);
        }

        .status-log {
            height: 120px;
            background: #000;
            border-radius: 15px;
            padding: 15px;
            font-family: monospace;
            color: #0f0;
            font-size: 0.9rem;
            overflow-y: auto;
            border: 1px solid #222;
        }

        /* Loader Overlay */
        .loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .loader-ring {
            width: 80px; height: 80px;
            border: 5px solid #111;
            border-top: 5px solid var(--neon-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="loader" id="loadingOverlay">
    <div class="loader-ring"></div>
    <h2 style="color: var(--neon-blue); margin-top: 20px;">×”-AI ××œ×—×™×Ÿ ×¢×‘×•×¨×š ×™×¦×™×¨×ª ××•×¤×ª...</h2>
    <p id="loaderStatus">×× ×ª×— ×”×¨××•× ×™×•×ª ×•×‘×•× ×” ×¢×¨×•×¦×™ ×¡××•× ×“...</p>
</div>

<div class="container">
    <header>
        <h1>AI MUSIC MONSTER</h1>
        <p>××•×œ×¤×Ÿ ×”×¤×§×” ××§×¦×•×¢×™ ××‘×•×¡×¡ ×‘×™× ×” ××œ××›×•×ª×™×ª</p>
    </header>

    <div class="main-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="control-group">
                <label>××¤×ª×— Gemini API</label>
                <input type="password" id="apiKey" placeholder="×”×›× ×¡ ××ª ×”××¤×ª×— ×›××Ÿ...">
            </div>

            <div class="control-group">
                <label>×ª××¨ ××ª ×”×©×™×¨ (×¡×’× ×•×Ÿ, ×›×œ×™ × ×’×™× ×”, ××•×•×™×¨×”)</label>
                <textarea id="prompt" placeholder="×œ××©×œ: ×©×™×¨ ×˜×¨×× ×¡ ×¢×•×¦××ª×™ ×¢× ×‘×¡ ×¢××•×§, ×’×™×˜×¨×•×ª ×—×©××œ×™×•×ª ×‘×¨×§×¢, ×•×ª×•×¤×™× ×©×œ ×œ×”×§×ª ×¨×•×§ ×‘×¡× ×›×¨×•×Ÿ ××œ×..."></textarea>
            </div>

            <div class="control-group">
                <label>××•×¨×š ×”×©×™×¨ ×”××‘×•×§×©</label>
                <select id="duration">
                    <option value="1">×“×§×” ××—×ª (×§×¦×¨)</option>
                    <option value="3" selected>3 ×“×§×•×ª (×¡×˜× ×“×¨×˜×™)</option>
                    <option value="5">5 ×“×§×•×ª (××¨×•×š)</option>
                    <option value="7">7 ×“×§×•×ª (××¤×™)</option>
                </select>
            </div>

            <button class="btn btn-primary" onclick="generateProject()">âš¡ ×¦×•×¨ ×©×™×¨ ×—×“×© (AI)</button>
            <button class="btn btn-success" id="playBtn" onclick="togglePlayback()" disabled>â–¶ × ×’×Ÿ / ×”×©×”×”</button>
            <button class="btn btn-record" id="downloadBtn" onclick="downloadAudio()" disabled>ğŸ’¾ ×”×•×¨×“ ××ª ×”×©×™×¨ (WAV)</button>
            
            <div class="status-log" id="log">
                [××¢×¨×›×ª] ××•×›×Ÿ ×œ×¢×‘×•×“×”...
            </div>
        </aside>

        <!-- Workspace -->
        <main class="workspace">
            <div class="card visualizer-box">
                <div>
                    <label>×¡×¤×§×˜×¨×•× ×ª×“×¨×™×</label>
                    <canvas id="freqCanvas"></canvas>
                </div>
                <div>
                    <label>×¦×•×¨×ª ×’×œ (Waveform)</label>
                    <canvas id="waveCanvas"></canvas>
                </div>
            </div>

            <div class="card">
                <label>×¦×™×¨ ×–××Ÿ ×•××‘× ×” ×”×©×™×¨ (Arrangement)</label>
                <div class="timeline" id="timeline">
                    <!-- Segments go here -->
                </div>
            </div>

            <div class="card">
                <label>××™×§×¡×¨ ×¢×¨×•×¦×™× (10 ×¢×¨×•×¦×™× ×‘×¡× ×›×¨×•×Ÿ ××œ×)</label>
                <div class="mixer" id="mixer">
                    <!-- Channels go here -->
                </div>
            </div>
        </main>
    </div>
</div>

<script>
/**
 * AI MUSIC MONSTER - CORE ENGINE
 * ×ª××™×›×” ×‘×©×™×¨×™× ××¨×•×›×™×, 10 ×¢×¨×•×¦×™× ×‘××§×‘×™×œ ×•××¤×©×¨×•×ª ×”×•×¨×“×”
 */

const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
let audioCtx, masterBus, mainAnalyser, recorder, stream;
let isPlaying = false;
let currentBpm = 128;
let songData = [];
let currentPartIdx = 0;
let stepIdx = 0;
let timer;
let audioChunks = [];

const CHANNELS_INFO = [
    { id: 'kick', label: '×ª×•×¤×™× (K)', color: '#ff4444' },
    { id: 'snare', label: '×¡× ×™×™×¨ (S)', color: '#ffaa44' },
    { id: 'hihat', label: '××¦×™×œ×•×ª', color: '#ffff44' },
    { id: 'bass', label: '×‘×¡', color: '#44ff44' },
    { id: 'guitar', label: '×’×™×˜×¨×”', color: '#44ffff' },
    { id: 'organ', label: '××•×¨×’×Ÿ', color: '#4444ff' },
    { id: 'lead', label: '×¡×•×œ×•', color: '#aa44ff' },
    { id: 'pluck', label: '×¤×œ××§', color: '#ff44ff' },
    { id: 'pad', label: '××•×•×™×¨×”', color: '#ffffff' },
    { id: 'fx', label: '××¤×§×˜×™×', color: '#888888' }
];

const CHANNELS = {};

// --- ××ª×—×•×œ ---
window.onload = () => {
    const saved = localStorage.getItem('monster_api_key');
    if(saved) document.getElementById('apiKey').value = saved;
    setupMixerUI();
};

function setupMixerUI() {
    const mixer = document.getElementById('mixer');
    mixer.innerHTML = '';
    CHANNELS_INFO.forEach(ch => {
        const div = document.createElement('div');
        div.className = 'channel';
        div.innerHTML = `
            <div class="vu-meter"><div id="vu-${ch.id}" class="vu-fill"></div></div>
            <input type="range" class="fader" id="vol-${ch.id}" min="0" max="1" step="0.01" value="0.7">
            <div style="font-size:0.7rem; color:${ch.color}">${ch.label}</div>
        `;
        mixer.appendChild(div);
        CHANNELS[ch.id] = { gain: null, analyser: null };
    });
}

function addLog(msg) {
    const log = document.getElementById('log');
    log.innerHTML += `<div>> ${msg}</div>`;
    log.scrollTop = log.scrollHeight;
}

// --- ×× ×•×¢ ×”×¡××•× ×“ ---
async function initAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    masterBus = audioCtx.createGain();
    const limiter = audioCtx.createDynamicsCompressor();
    limiter.threshold.value = -1;
    
    mainAnalyser = audioCtx.createAnalyser();
    mainAnalyser.fftSize = 2048;

    masterBus.connect(limiter);
    limiter.connect(mainAnalyser);
    mainAnalyser.connect(audioCtx.destination);

    // ×™×¦×™×¨×ª ×¢×¨×•×¦×™×
    CHANNELS_INFO.forEach(ch => {
        const g = audioCtx.createGain();
        const a = audioCtx.createAnalyser();
        a.fftSize = 64;
        g.connect(a);
        a.connect(masterBus);
        CHANNELS[ch.id].gain = g;
        CHANNELS[ch.id].analyser = a;
    });

    // ×”×›× ×” ×œ×”×§×œ×˜×”
    const destination = audioCtx.createMediaStreamDestination();
    masterBus.connect(destination);
    recorder = new MediaRecorder(destination.stream);
    recorder.ondataavailable = e => audioChunks.push(e.data);
    recorder.onstop = exportWav;

    addLog("××•×œ×¤×Ÿ ×”×¡××•× ×“ ××•×›×Ÿ.");
}

// --- ×™×¦×™×¨×” ×¢× ×”-AI ---
async function generateProject() {
    const key = document.getElementById('apiKey').value;
    const prompt = document.getElementById('prompt').value;
    const durationMin = parseInt(document.getElementById('duration').value);
    
    if(!key) return addLog("×©×’×™××”: ×—×¡×¨ ××¤×ª×— API.");
    localStorage.setItem('monster_api_key', key);
    
    document.getElementById('loadingOverlay').style.display = 'flex';
    addLog(`××ª×—×™×œ ×™×¦×™×¨×ª ×©×™×¨ ×‘××•×¨×š ${durationMin} ×“×§×•×ª...`);

    // ×—×™×©×•×‘ ×›××•×ª ×”×‘×œ×•×§×™× (×›×œ ×‘×œ×•×§ ×”×•× ×‘×¢×¨×š 8 ×©× ×™×•×ª ×‘-120 BPM)
    const blocksNeeded = Math.ceil((durationMin * 60) / 8);

    const systemPrompt = `You are a Master Music Composer. Output ONLY JSON.
    Create a structure for a song with ${blocksNeeded} parts.
    Format: {
        "bpm": 120-145,
        "parts": [
            {
                "name": "Intro/Drop/Verse etc",
                "kick": [1,0,1,0...], (16 steps)
                "snare": [0,0,1,0...], (16 steps)
                "hihat": [...],
                "bass": [MIDI Freqs, 0 for silence],
                "guitar": [...],
                "organ": [...],
                "lead": [...],
                "pluck": [...],
                "pad": [...],
                "fx": [...]
            }
        ]
    }
    IMPORTANT: All 10 instruments must work TOGETHER in harmony (same scale, matching rhythm).
    Ensure the song has a logical progression (Intro -> Verse -> Build -> Drop -> Outro).`;

    try {
        const response = await fetch(`${API_URL}?key=${key}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                contents: [{ parts: [{ text: `Produce a ${prompt} track, ${durationMin} minutes long.` }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            })
        });

        const resData = await response.json();
        const jsonText = resData.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
        const parsed = JSON.parse(jsonText);

        currentBpm = parsed.bpm;
        songData = parsed.parts;
        
        renderTimeline();
        await initAudio();
        
        document.getElementById('playBtn').disabled = false;
        document.getElementById('downloadBtn').disabled = false;
        addLog(`×”×©×™×¨ ×”×•×œ×—×Ÿ! BPM: ${currentBpm}. ××•×›×Ÿ ×œ× ×’×™× ×”.`);
    } catch (e) {
        addLog("×©×’×™××” ×‘×™×¦×™×¨×”. ×•×•×“× ×©×”××¤×ª×— ×ª×§×™×Ÿ.");
        console.error(e);
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

function renderTimeline() {
    const tl = document.getElementById('timeline');
    tl.innerHTML = '';
    songData.forEach((p, i) => {
        const div = document.createElement('div');
        div.className = 'segment';
        div.innerText = p.name || `×—×œ×§ ${i+1}`;
        div.id = `seg-${i}`;
        tl.appendChild(div);
    });
}

// --- ×¡×§×•×•× ×¡×¨ ×•× ×’×™× ×” ---
function togglePlayback() {
    if(isPlaying) {
        isPlaying = false;
        clearInterval(timer);
        if(recorder.state === "recording") recorder.stop();
        addLog("× ×’×™× ×” ×”×•×¤×¡×§×”.");
    } else {
        isPlaying = true;
        currentPartIdx = 0;
        stepIdx = 0;
        audioChunks = [];
        recorder.start();
        runEngine();
        addLog("× ×’×™× ×” ×•×”×§×œ×˜×” ×”×ª×—×™×œ×•...");
    }
}

function runEngine() {
    const stepTime = 60 / currentBpm / 4;
    let nextNoteTime = audioCtx.currentTime + 0.1;

    function scheduler() {
        while(nextNoteTime < audioCtx.currentTime + 0.2) {
            playStep(nextNoteTime);
            nextNoteTime += stepTime;
            advance();
        }
        if(isPlaying) timer = setTimeout(scheduler, 25);
    }
    scheduler();
    requestAnimationFrame(draw);
}

function advance() {
    stepIdx++;
    if(stepIdx >= 16) {
        stepIdx = 0;
        currentPartIdx++;
        if(currentPartIdx >= songData.length) {
            togglePlayback(); // ×¡×•×£ ×”×©×™×¨
            return;
        }
        updateTimelineUI();
    }
}

function updateTimelineUI() {
    document.querySelectorAll('.segment').forEach(s => s.classList.remove('active'));
    document.getElementById(`seg-${currentPartIdx}`).classList.add('active');
}

// --- ×¡×™× ×ª×–×” ×‘×–××Ÿ ×××ª ---
function playStep(time) {
    const part = songData[currentPartIdx];
    
    // ×ª×•×¤×™×
    if(part.kick[stepIdx]) triggerKick(time);
    if(part.snare[stepIdx]) triggerSnare(time);
    if(part.hihat[stepIdx]) triggerHat(time);

    // ×›×œ×™× ×”×¨××•× ×™×™× (×‘×™×—×“!)
    if(part.bass[stepIdx]) triggerSynth('bass', part.bass[stepIdx], time, 0.2, 'sawtooth');
    if(part.guitar[stepIdx]) triggerSynth('guitar', part.guitar[stepIdx], time, 0.15, 'triangle');
    if(part.organ[stepIdx]) triggerSynth('organ', part.organ[stepIdx], time, 0.4, 'square');
    if(part.lead[stepIdx]) triggerSynth('lead', part.lead[stepIdx], time, 0.3, 'sawtooth');
    if(part.pluck[stepIdx]) triggerSynth('pluck', part.pluck[stepIdx], time, 0.1, 'sine');
}

function triggerKick(t) {
    const osc = audioCtx.createOscillator();
    const env = audioCtx.createGain();
    osc.frequency.setValueAtTime(150, t);
    osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.5);
    env.gain.setValueAtTime(1, t);
    env.gain.exponentialRampToValueAtTime(0.01, t + 0.5);
    osc.connect(env);
    env.connect(CHANNELS.kick.gain);
    osc.start(t); osc.stop(t + 0.5);
}

function triggerSnare(t) {
    const noise = audioCtx.createBufferSource();
    const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.1, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for(let i=0; i<data.length; i++) data[i] = Math.random() * 2 - 1;
    noise.buffer = buffer;
    const env = audioCtx.createGain();
    env.gain.setValueAtTime(0.5, t);
    env.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
    noise.connect(env);
    env.connect(CHANNELS.snare.gain);
    noise.start(t);
}

function triggerHat(t) {
    const osc = audioCtx.createOscillator();
    osc.type = 'hihat'; // ××“×•××” ×¢"×™ ×ª×“×¨ ×’×‘×•×”
    osc.frequency.setValueAtTime(10000, t);
    const env = audioCtx.createGain();
    env.gain.setValueAtTime(0.2, t);
    env.gain.exponentialRampToValueAtTime(0.01, t + 0.05);
    osc.connect(env);
    env.connect(CHANNELS.hihat.gain);
    osc.start(t); osc.stop(t + 0.05);
}

function triggerSynth(id, freq, t, dur, type) {
    const osc = audioCtx.createOscillator();
    const env = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, t);
    env.gain.setValueAtTime(0.3, t);
    env.gain.exponentialRampToValueAtTime(0.01, t + dur);
    osc.connect(env);
    env.connect(CHANNELS[id].gain);
    osc.start(t); osc.stop(t + dur);
}

// --- ×•×™×–×•××œ×™×–×¦×™×” ---
function draw() {
    if(!isPlaying) return;
    requestAnimationFrame(draw);

    const fC = document.getElementById('freqCanvas');
    const fCtx = fC.getContext('2d');
    fC.width = fC.offsetWidth; fC.height = fC.offsetHeight;
    const fData = new Uint8Array(mainAnalyser.frequencyBinCount);
    mainAnalyser.getByteFrequencyData(fData);
    fCtx.fillStyle = '#000'; fCtx.fillRect(0,0,fC.width,fC.height);
    for(let i=0; i<fData.length; i++) {
        const h = (fData[i]/255) * fC.height;
        fCtx.fillStyle = `hsl(${i/2}, 100%, 50%)`;
        fCtx.fillRect(i*3, fC.height-h, 2, h);
    }

    const wC = document.getElementById('waveCanvas');
    const wCtx = wC.getContext('2d');
    wC.width = wC.offsetWidth; wC.height = wC.offsetHeight;
    const wData = new Uint8Array(mainAnalyser.fftSize);
    mainAnalyser.getByteTimeDomainData(wData);
    wCtx.fillStyle = '#000'; wCtx.fillRect(0,0,wC.width,wC.height);
    wCtx.strokeStyle = var('--neon-blue'); wCtx.lineWidth = 2;
    wCtx.beginPath();
    let x = 0; let slice = wC.width / wData.length;
    for(let i=0; i<wData.length; i++) {
        let v = wData[i]/128.0; let y = v * wC.height/2;
        if(i===0) wCtx.moveTo(x,y); else wCtx.lineTo(x,y);
        x += slice;
    }
    wCtx.stroke();

    // ×¢×“×›×•×Ÿ ×•×•×œ×™×•× ×‘××™×§×¡×¨
    CHANNELS_INFO.forEach(ch => {
        const data = new Uint8Array(1);
        CHANNELS[ch.id].analyser.getByteFrequencyData(data);
        document.getElementById(`vu-${ch.id}`).style.height = `${(data[0]/255)*100}%`;
        const vol = document.getElementById(`vol-${ch.id}`).value;
        CHANNELS[ch.id].gain.gain.setTargetAtTime(vol, audioCtx.currentTime, 0.05);
    });
}

// --- ×”×•×¨×“×” ---
function downloadAudio() {
    if(audioChunks.length === 0) return addLog("× ×’×Ÿ ××ª ×”×©×™×¨ ×œ×¤×—×•×ª ×¤×¢× ××—×ª ×›×“×™ ×œ×”×§×œ×™×˜ ××•×ª×•.");
    recorder.stop();
}

function exportWav() {
    const blob = new Blob(audioChunks, { type: 'audio/wav' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'AI_Music_Monster_Track.wav';
    a.click();
    addLog("×”×§×•×‘×¥ ××•×›×Ÿ ×œ×”×•×¨×“×”!");
}

</script>
</body>
</html>
