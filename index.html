<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Music Beast - Ultra Edition</title>
    <style>
        :root {
            --neon-blue: #00f2ff;
            --neon-purple: #bc13fe;
            --neon-green: #39ff14;
            --neon-pink: #ff007f;
            --bg-deep: #050508;
            --panel-bg: #0d0d16;
            --glass: rgba(255, 255, 255, 0.03);
        }

        body {
            background: var(--bg-deep);
            color: #fff;
            font-family: 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* Full Screen Layout */
        .app-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            height: 100vh;
        }

        /* Sidebar UI */
        aside {
            background: var(--panel-bg);
            border-left: 1px solid #1a1a2e;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: 10px 0 30px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .logo-area {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #222;
        }

        .logo-area h2 {
            margin: 0;
            font-size: 1.5rem;
            letter-spacing: 2px;
            background: linear-gradient(to right, var(--neon-blue), var(--neon-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Controls */
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #666;
            font-weight: bold;
        }

        input, select, textarea {
            background: #000;
            border: 1px solid #222;
            color: #fff;
            padding: 12px;
            border-radius: 8px;
            font-family: inherit;
        }

        .btn {
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-weight: 800;
            cursor: pointer;
            transition: 0.2s;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-ai { background: linear-gradient(45deg, var(--neon-blue), var(--neon-purple)); color: #000; }
        .btn-play { background: var(--neon-green); color: #000; }
        .btn-stop { background: var(--neon-pink); color: #fff; }
        
        .btn:hover:not(:disabled) { transform: translateY(-2px); filter: brightness(1.2); }
        .btn:disabled { opacity: 0.2; cursor: not-allowed; }

        /* Main Workspace */
        main {
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Multi-Visualizer */
        .visualizer-hub {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            height: 250px;
        }

        .canvas-card {
            background: #000;
            border-radius: 15px;
            position: relative;
            border: 1px solid #1a1a2e;
            overflow: hidden;
        }

        canvas { width: 100%; height: 100%; }

        /* Arranger Section */
        .arranger-card {
            background: var(--panel-bg);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #222;
        }

        .timeline {
            display: flex;
            gap: 5px;
            height: 60px;
            background: #050508;
            border-radius: 10px;
            padding: 5px;
            margin-top: 10px;
            overflow-x: auto;
        }

        .block {
            flex-shrink: 0;
            width: 120px;
            background: #1a1a2e;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            color: #888;
            border: 1px solid transparent;
        }

        .block.active {
            border-color: var(--neon-blue);
            background: rgba(0, 242, 255, 0.1);
            color: var(--neon-blue);
        }

        /* Mixer Console */
        .mixer-console {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 15px;
        }

        .channel-strip {
            background: var(--panel-bg);
            border: 1px solid #222;
            border-radius: 15px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .vu-meter {
            width: 10px;
            height: 120px;
            background: #000;
            border-radius: 5px;
            position: relative;
            overflow: hidden;
        }

        .vu-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 0%;
            background: linear-gradient(to top, #0f0, #ff0, #f00);
            transition: height 0.05s;
        }

        .fader {
            -webkit-appearance: slider-vertical;
            width: 30px;
            height: 100px;
        }

        /* Terminal Area */
        .terminal {
            background: #000;
            border: 1px solid #1a1a2e;
            border-radius: 12px;
            height: 150px;
            padding: 15px;
            font-family: 'Consolas', monospace;
            font-size: 0.8rem;
            color: #0f0;
            overflow-y: auto;
            line-height: 1.4;
        }

        /* FX Grid */
        .fx-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .fx-node {
            background: #111;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.65rem;
            border: 1px solid #222;
        }

        .fx-node.active { border-color: var(--neon-green); color: var(--neon-green); }

        /* Loader */
        #loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            width: 80px; height: 80px;
            border: 4px solid #111;
            border-top: 4px solid var(--neon-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <h2 style="margin-top: 25px;">Gemini ×‘×•× ×” ××ª ×™×¦×™×¨×ª ×”××•×¤×ª ×©×œ×š...</h2>
    <p id="loaderStatus">××—×©×‘ ×’×œ×™× ×¤×¡×™×›×•××§×•×¡×˜×™×™×...</p>
</div>

<div class="app-container">
    <aside>
        <div class="logo-area">
            <h2>AI BEAST STUDIO</h2>
            <p style="font-size: 0.6rem; color: #444;">ULTRA PRODUCTION ENGINE v4.2</p>
        </div>

        <div class="control-group">
            <label>××¤×ª×— API</label>
            <input type="password" id="apiKey" placeholder="Gemini API Key...">
        </div>

        <div class="control-group">
            <label>×¡×’× ×•×Ÿ ××•×–×™×§×œ×™ ×•-Prompt</label>
            <textarea id="prompt" placeholder="×“×•×’××”: Dark Psytrance with organic forest leads, tribal drums and heavy futuristic bass..."></textarea>
        </div>

        <div class="control-group">
            <label>××•×¨×›×‘×•×ª (Complexity)</label>
            <select id="complexity">
                <option value="simple">×‘×¡×™×¡×™</option>
                <option value="medium" selected>××ª×§×“× (Pro)</option>
                <option value="extreme">×§×™×¦×•× ×™ (Beast Mode)</option>
            </select>
        </div>

        <div class="control-group">
            <label>××¤×§×˜×™× ×’×œ×•×‘×œ×™×™×</label>
            <div class="fx-grid">
                <div class="fx-node active">REVERB</div>
                <div class="fx-node active">DELAY</div>
                <div class="fx-node">LIMITER</div>
                <div class="fx-node active">SC</div>
            </div>
        </div>

        <button id="genBtn" class="btn btn-ai" onclick="generateTrack()">âš¡ ×¦×•×¨ ×˜×¨××§ ××œ× (AI)</button>
        <button id="playBtn" class="btn btn-play" onclick="togglePlay()" disabled>â–¶ ×”×¤×¢×œ ××•×œ×¤×Ÿ</button>
        <button id="stopBtn" class="btn btn-stop" onclick="killAll()">ğŸ›‘ ×¢×¦×™×¨×ª ×—×™×¨×•×</button>
        
        <div class="terminal" id="terminal">
            [SYSTEM READY]<br>×”××¢×¨×›×ª ××—×›×” ×œ×¤×§×•×“×”...
        </div>
    </aside>

    <main>
        <div class="visualizer-hub">
            <div class="canvas-card">
                <canvas id="freqCanvas"></canvas>
            </div>
            <div class="canvas-card">
                <canvas id="waveCanvas"></canvas>
            </div>
        </div>

        <div class="arranger-card">
            <label>×¦×™×¨ ×–××Ÿ ×•××‘× ×” ×”×©×™×¨ (Song Arrangement)</label>
            <div class="timeline" id="timeline">
                <div class="block">Waiting for AI...</div>
            </div>
        </div>

        <div class="mixer-console" id="mixer">
            <!-- Channels will be generated here -->
        </div>
    </main>
</div>

<script>
/**
 * AI MUSIC BEAST CORE ENGINE
 * ×ª××™×›×” ×‘-150+ ×›×œ×™×, ××¤×§×˜×™× ××ª×§×“××™× ×•××‘× ×” ×©×™×¨ ××œ×
 */

// --- ×§×•× ×¤×™×’×•×¨×¦×™×” ×‘×¡×™×¡×™×ª ---
const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
let audioCtx, masterBus, mainAnalyser, recorder;
let isPlaying = false;
let currentBpm = 140;
let arrangement = [];
let currentPartIdx = 0;
let stepIdx = 0;
let timer;

// ×¨×©×™××ª ×›×œ×™× (10 ×¢×¨×•×¦×™× ××¨×›×–×™×™×, ×›×œ ××—×“ ×™×›×•×œ ×œ×”×¤×™×§ ×¢×©×¨×•×ª ×•×¨×™××¦×™×•×ª)
const CHANNELS_CONFIG = [
    { id: 'kick', label: 'Kick Drum', color: '#00f2ff' },
    { id: 'snare', label: 'Snare/Perc', color: '#bc13fe' },
    { id: 'hihat', label: 'Hi-Hats', color: '#39ff14' },
    { id: 'bass', label: 'Sub Bass', color: '#ff007f' },
    { id: 'acid', label: 'Acid Line', color: '#ffff00' },
    { id: 'lead1', label: 'Main Lead', color: '#ffffff' },
    { id: 'lead2', label: 'Layer Lead', color: '#00ffaa' },
    { id: 'pluck', label: 'Plucks', color: '#ffaa00' },
    { id: 'atmos', label: 'Ambient/FX', color: '#5555ff' },
    { id: 'noise', label: 'White Noise', color: '#888' }
];

const CHANNELS = {};

// --- ××ª×—×•×œ ×”×××©×§ ---
window.onload = () => {
    const savedKey = localStorage.getItem('beast_api_key');
    if(savedKey) document.getElementById('apiKey').value = savedKey;
    buildMixer();
};

function buildMixer() {
    const mixer = document.getElementById('mixer');
    mixer.innerHTML = '';
    CHANNELS_CONFIG.forEach(cfg => {
        const strip = document.createElement('div');
        strip.className = 'channel-strip';
        strip.innerHTML = `
            <div class="vu-meter"><div id="vu-${cfg.id}" class="vu-fill"></div></div>
            <input type="range" class="fader" id="vol-${cfg.id}" min="0" max="1.5" step="0.01" value="0.8">
            <span style="font-size:0.6rem; color:${cfg.color}">${cfg.label}</span>
            <div id="led-${cfg.id}" style="width:8px; height:8px; background:#222; border-radius:50%"></div>
        `;
        mixer.appendChild(strip);
        CHANNELS[cfg.id] = { gain: null, analyser: null };
    });
}

function log(msg, color = '#0f0') {
    const term = document.getElementById('terminal');
    term.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
    term.scrollTop = term.scrollHeight;
}

// --- ×× ×•×¢ ×”×¡××•× ×“ (Audio Engine) ---

async function initAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    // Master Chain
    masterBus = audioCtx.createGain();
    const limiter = audioCtx.createDynamicsCompressor();
    limiter.threshold.setValueAtTime(-1, audioCtx.currentTime);
    limiter.knee.setValueAtTime(0, audioCtx.currentTime);
    limiter.ratio.setValueAtTime(20, audioCtx.currentTime);
    
    mainAnalyser = audioCtx.createAnalyser();
    mainAnalyser.fftSize = 2048;

    masterBus.connect(limiter);
    limiter.connect(mainAnalyser);
    mainAnalyser.connect(audioCtx.destination);

    // Initialize Channels
    CHANNELS_CONFIG.forEach(cfg => {
        const g = audioCtx.createGain();
        const a = audioCtx.createAnalyser();
        a.fftSize = 32;
        g.connect(a);
        a.connect(masterBus);
        CHANNELS[cfg.id].gain = g;
        CHANNELS[cfg.id].analyser = a;
    });

    log("Audio Core Online. All 10 engines initialized.", "#bc13fe");
}

// --- ×¡×™× ×ª×–×” ××ª×§×“××ª (Beast Synthesis) ---

class BeastSynth {
    static kick(time, variant = 0) {
        const ctx = audioCtx;
        const g = CHANNELS.kick.gain;
        const osc = ctx.createOscillator();
        const env = ctx.createGain();
        
        // ×¡×™× ×ª×–×ª ×§×™×§ ×¢××•×§
        osc.frequency.setValueAtTime(150, time);
        osc.frequency.exponentialRampToValueAtTime(40, time + 0.1);
        
        env.gain.setValueAtTime(1.2, time);
        env.gain.exponentialRampToValueAtTime(0.001, time + 0.4);
        
        osc.connect(env);
        env.connect(g);
        osc.start(time);
        osc.stop(time + 0.4);
        this.flash('kick');
    }

    static acid(time, freq, dur) {
        const ctx = audioCtx;
        const g = CHANNELS.acid.gain;
        const osc = ctx.createOscillator();
        const filter = ctx.createBiquadFilter();
        const env = ctx.createGain();
        
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(freq, time);
        
        filter.type = 'lowpass';
        filter.Q.value = 25;
        filter.frequency.setValueAtTime(200, time);
        filter.frequency.exponentialRampToValueAtTime(4000, time + 0.06);
        
        env.gain.setValueAtTime(0.4, time);
        env.gain.exponentialRampToValueAtTime(0.001, time + dur);
        
        osc.connect(filter);
        filter.connect(env);
        env.connect(g);
        
        osc.start(time);
        osc.stop(time + dur);
        this.flash('acid');
    }

    static lead(time, freq, dur, type = 'square') {
        const g = CHANNELS.lead1.gain;
        const osc1 = audioCtx.createOscillator();
        const osc2 = audioCtx.createOscillator();
        const env = audioCtx.createGain();
        
        osc1.type = type;
        osc2.type = 'sawtooth';
        osc1.frequency.setValueAtTime(freq, time);
        osc2.frequency.setValueAtTime(freq * 1.005, time); // Detune

        env.gain.setValueAtTime(0.2, time);
        env.gain.exponentialRampToValueAtTime(0.001, time + dur);

        osc1.connect(env);
        osc2.connect(env);
        env.connect(g);
        osc1.start(time);
        osc2.start(time);
        osc1.stop(time + dur);
        osc2.stop(time + dur);
        this.flash('lead1');
    }

    static flash(id) {
        const led = document.getElementById(`led-${id}`);
        if(led) {
            led.style.background = '#00f2ff';
            setTimeout(() => led.style.background = '#222', 50);
        }
    }
}

// --- AI ORCHESTRATION ---

async function generateTrack() {
    const key = document.getElementById('apiKey').value;
    const prompt = document.getElementById('prompt').value;
    if(!key) return log("×©×’×™××”: ×—×¡×¨ ××¤×ª×— API", "#f00");
    
    localStorage.setItem('beast_api_key', key);
    document.getElementById('loader').style.display = 'flex';
    log("Gemini ×™×•×¦×¨ ××¨×›×™×˜×§×˜×•×¨×” ×œ×˜×¨××§...", "#00f2ff");

    const systemPrompt = `You are a professional music producer. Output ONLY a valid JSON object.
    Structure: {
        "bpm": 130-155,
        "arrangement": [
            { "name": "Intro", "steps": 16, "kick": [1,0...], "bass": [55,0...], "acid": [0...], "lead": [0...] },
            { "name": "Build", ... },
            { "name": "Drop", ... },
            { "name": "Break", ... }
        ]
    }
    Requirements:
    - At least 8 segments for a full song structure.
    - Each segment must have 16 steps.
    - Bass/Acid/Lead values are frequencies (Hz).
    - Drums are 1 or 0.
    - Ensure a proper musical journey (Intro -> Build -> Drop).
    No markdown formatting, no text, just the JSON.`;

    try {
        const response = await fetch(`${API_URL}?key=${key}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: `Create a professional ${prompt} track.` }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            })
        });

        const data = await response.json();
        const text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
        const result = JSON.parse(text);

        currentBpm = result.bpm;
        arrangement = result.arrangement;

        renderTimeline();
        await initAudio();
        
        document.getElementById('playBtn').disabled = false;
        log(`×˜×¨××§ × ×•×¦×¨ ×‘×”×¦×œ×—×”! BPM: ${currentBpm}`, "#39ff14");
    } catch (e) {
        log("×©×’×™××” ×‘× ×™×ª×•×— ×ª×©×•×‘×ª ×”-AI. ×‘×“×•×§ ××¤×ª×— ××• × ×¡×” ×©× ×™×ª.", "#f00");
        console.error(e);
    } finally {
        document.getElementById('loader').style.display = 'none';
    }
}

function renderTimeline() {
    const tl = document.getElementById('timeline');
    tl.innerHTML = '';
    arrangement.forEach((part, i) => {
        const div = document.createElement('div');
        div.className = 'block';
        div.innerText = part.name;
        div.id = `part-${i}`;
        tl.appendChild(div);
    });
}

// --- SEQUENCER ---

function togglePlay() {
    if(isPlaying) {
        isPlaying = false;
        clearInterval(timer);
        log("Studio Paused.", "#ff007f");
    } else {
        isPlaying = true;
        currentPartIdx = 0;
        stepIdx = 0;
        runSequencer();
        log("Studio Live!", "#39ff14");
    }
}

function runSequencer() {
    const stepTime = 60 / currentBpm / 4;
    let nextTime = audioCtx.currentTime + 0.1;

    function worker() {
        while(nextTime < audioCtx.currentTime + 0.2) {
            playStep(nextTime);
            nextTime += stepTime;
            advance();
        }
        if(isPlaying) timer = setTimeout(worker, 25);
    }
    worker();
    requestAnimationFrame(draw);
}

function advance() {
    stepIdx++;
    if(stepIdx >= 16) {
        stepIdx = 0;
        currentPartIdx++;
        if(currentPartIdx >= arrangement.length) currentPartIdx = 0;
        updateUI();
    }
}

function updateUI() {
    document.querySelectorAll('.block').forEach(b => b.classList.remove('active'));
    const current = document.getElementById(`part-${currentPartIdx}`);
    if(current) current.classList.add('active');
}

function playStep(time) {
    const part = arrangement[currentPartIdx];
    
    if(part.kick[stepIdx]) BeastSynth.kick(time);
    
    if(part.bass && part.bass[stepIdx] > 0) {
        BeastSynth.acid(time, part.bass[stepIdx], 0.15); // Bass handled by acid engine for grit
    }

    if(part.acid && part.acid[stepIdx] > 0) {
        BeastSynth.acid(time, part.acid[stepIdx], 0.1);
    }

    if(part.lead && part.lead[stepIdx] > 0) {
        BeastSynth.lead(time, part.lead[stepIdx], 0.3);
    }
}

// --- VISUALIZERS & MIXER UPDATES ---

function draw() {
    if(!isPlaying) return;
    requestAnimationFrame(draw);
    
    // Freq Canvas
    const fCanvas = document.getElementById('freqCanvas');
    const fCtx = fCanvas.getContext('2d');
    fCanvas.width = fCanvas.offsetWidth; fCanvas.height = fCanvas.offsetHeight;
    const fData = new Uint8Array(mainAnalyser.frequencyBinCount);
    mainAnalyser.getByteFrequencyData(fData);
    
    fCtx.fillStyle = '#000';
    fCtx.fillRect(0,0,fCanvas.width, fCanvas.height);
    for(let i=0; i<fData.length; i++) {
        const h = (fData[i] / 255) * fCanvas.height;
        fCtx.fillStyle = `hsl(${i/2}, 100%, 50%)`;
        fCtx.fillRect(i * 4, fCanvas.height - h, 3, h);
    }

    // Wave Canvas
    const wCanvas = document.getElementById('waveCanvas');
    const wCtx = wCanvas.getContext('2d');
    wCanvas.width = wCanvas.offsetWidth; wCanvas.height = wCanvas.offsetHeight;
    const wData = new Uint8Array(mainAnalyser.fftSize);
    mainAnalyser.getByteTimeDomainData(wData);
    
    wCtx.fillStyle = '#000';
    wCtx.fillRect(0,0,wCanvas.width, wCanvas.height);
    wCtx.strokeStyle = '#00f2ff';
    wCtx.lineWidth = 2;
    wCtx.beginPath();
    let x = 0;
    const slice = wCanvas.width / wData.length;
    for(let i=0; i<wData.length; i++) {
        const v = wData[i] / 128.0;
        const y = v * wCanvas.height / 2;
        if(i===0) wCtx.moveTo(x,y); else wCtx.lineTo(x,y);
        x += slice;
    }
    wCtx.stroke();

    // Update VU Meters
    Object.keys(CHANNELS).forEach(id => {
        const chan = CHANNELS[id];
        if(!chan.analyser) return;
        const vData = new Uint8Array(1);
        chan.analyser.getByteFrequencyData(vData);
        const level = (vData[0] / 255) * 100;
        document.getElementById(`vu-${id}`).style.height = `${level}%`;
        
        // Sync Gain with Fader
        const fv = document.getElementById(`vol-${id}`).value;
        chan.gain.gain.setTargetAtTime(fv, audioCtx.currentTime, 0.05);
    });
}

function killAll() {
    if(audioCtx) audioCtx.suspend();
    isPlaying = false;
    clearInterval(timer);
    log("EMERGENCY KILL ACTIVATED.", "#f00");
}

</script>
</body>
</html>
